<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Calendar</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

    <link rel='stylesheet' href='/static/css/fullcalendar.min.css' />
    <script src='/static/js/lib/jquery.min.js'></script>
    <script src='/static/js/lib/moment.min.js'></script>
    <script src='/static/js/fullcalendar.min.js'></script>
</head>
<body>

<div class="tab-panel">
    <form th:id="filterForm" method="post"
          th:action="@{'/event-calendar/data'}" onsubmit="return false;">
        <label title="Show">Show</label>
        <select id="filterS" title="Show" class="js_show" th:field="*{filter.show}">
            <option th:selected="${filter.show=='Class Type'}" th:value="'Class Type'">Class Type</option>
            <option th:selected="${filter.show=='Empty Seats Class'}" th:value="'Empty Seats Class'">Empty Seats Class</option>
            <option th:selected="${filter.show=='Empty Seats Course'}" th:value="'Empty Seats Course'">Empty Seats Course</option>
        </select>

        <label title="Filter by Type">Filter by Type</label>
        <select id="type" title="filter By Type" th:field="*{filter.type}">
            <option th:selected="${filter.type=='Class Type'}" th:value="'Class Type'"> Class Type</option>
            <option th:selected="${filter.type=='Teacher'}" th:value="'Teacher'">Teacher</option>
        </select>

        <input type="text" id="value" class="js_filter" th:field="*{filter.value}"
               placeholder="Filter by value"/>
    </form>
</div>

<br/>

<div id="calendar"></div>

</body>

<script>
    $(document).ready(function() {

        function isEmpty(obj) {
            for(var key in obj) {
                if(obj.hasOwnProperty(key))
                    return false;
            }
            return true;
        }

        function refresh(events){
            var calendar = $('#calendar');
            calendar.fullCalendar('removeEvents');
            calendar.fullCalendar('addEventSource', events);
            calendar.fullCalendar('rerenderEvents' );
        }

        function deleteEvent(id){
            $.ajax({
                url: "/event-calendar/delete/"+id,
                type: "GET",
            }).done(function(events) {
               console.log('delete item');
               refresh(events);
            });
        }

        function addEvent(calEvent){
            var data = JSON.stringify(calEvent);
            $.ajax({
                url: "/event-calendar/add",
                contentType: 'application/json',
                type: "POST",
                data: data
            }).done(function(events) {
                console.log('add item');
                refresh(events);
            }).fail(function(xhr, status, error) {
                console.log(error);
            });
        }

        $('#calendar').fullCalendar({
            schedulerLicenseKey: 'CC-Attribution-NonCommercial-NoDerivatives',
            aspectRatio: 1,
            businessHours: {
                dow: [ 1, 2, 3, 4, 5, 6 ], // Mo - Sa
                start: '09:00', // a start time
                end: '22:00' // an end time
            },
            hiddenDays: [ 0 ],
            firstDay: 1,
            minTime:"09:00",
            maxTIme:"22:00",
            timezone: 'America/Montevideo',
            allDaySlot: false,
            defaultView: 'agendaThreeDay',
            editable: true,
            header: {
                left: 'prev,next today',
                center: 'title',
                right: 'month,agendaWeek,agendaThreeDay,agendaDay'
            },
            eventLimit: true,
            views: {
                agendaThreeDay: {
                    type: 'agenda',
                    duration: { days: 3 },
                    buttonText: '3 day',
                    eventLimit: 3
                }
            },
            selectable: true,
            events: "/event-calendar/data",  // read json data from controller

            eventClick: function(calEvent, jsEvent, view) {

                // change the border color just for fun
                $(this).css('border-color', 'red');

                if (confirm('Are you sure you want to delete event '+ calEvent.title +' ?')) {
                   // delete event
                    deleteEvent(calEvent.id);
                }

            },
            // render other flags
            eventRender: function(event, el) {

                // select view type
                var fs = $('.js_show').find(":selected").text();
                var show=1;
                if (fs=='Empty Seats Class'){
                    show=2;
                } else if (fs=='Empty Seats Course'){
                    show=3;
                }

                if (show==1) {
                    if (!isEmpty(event.teacher)) {
                        el.find('.fc-title').after(
                            $('<span> - ' + event.teacher + '</span>')
                        );
                    }

                    if (event.count > 1) {
                        el.find('.fc-title').after(
                            $('<img class="image" src="/static/img/some.png"/>' +
                                '<span>[' + event.count + ']</span>')
                        );
                    } else if (event.count == 1) {
                        el.find('.fc-title').after(
                            $('<img class="image" src="/static/img/one.png"/>' +
                                '<span>[' + event.count + ']</span>')
                        );
                    }
                }

            },
            select: function (start, end, jsEvent, view) {

                //var abc = prompt('Enter Title of event');
                var newEvent = new Object();
                newEvent.title = 'test default event';
                newEvent.start = moment(start).format();
                newEvent.end = moment(start.clone().add(1,'hour')).format();
                newEvent.allDay = false;
                addEvent(newEvent);
                //$('#calendar').fullCalendar('renderEvent', newEvent);
            },
        });

        //--- binding actions ------

        $("#add").bind('click',  function() {

            var newEvent = new Object();

            newEvent.title = "some text";
            newEvent.start = '2018-01-29T19:30:00';
            newEvent.end = '2018-01-29T20:00:00';
            newEvent.allDay = false;

            $('#calendar').fullCalendar('renderEvent', newEvent);

        });

        $(".js_filter").keyup(function(){

            var form = $('#filterForm');
            var data = form.serialize();
            var url = form.attr('action');
            var type = form.attr('method');

            $.ajax({
                url: url,
                type: type,
                data: data
            }).done(function(events) {
                refresh(events);
            }).fail(function(xhr, status, error) {
                console.log(error);
            });
        });

        $(".js_show").change(function(){

            var form = $('#filterForm');
            var data = form.serialize();
            var url = form.attr('action');
            var type = form.attr('method');

            $.ajax({
                url: url,
                type: type,
                data: data
            }).done(function(events) {
                refresh(events);
            }).fail(function(xhr, status, error) {
                console.log(error);
            });
        });

    });
</script>
<style type='text/css'>

    body {
        margin-top: 40px;
        text-align: center;
        font-size: 14px;
        font-family: "Lucida Grande",Helvetica,Arial,Verdana,sans-serif;
    }

    #calendar {
        /*width: 900px;*/
        width: 100%;
        height: 100%;
        margin: 0 auto;
    }
    .image{
        height:13px;
        float:left;
    }

</style>
</html>